<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pokar Greens Support Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="chat-container">
    <div class="chat-header">
      <img src="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" alt="Bot Avatar" class="bot-avatar">
      <div>
        <div class="chat-title">Pokar Greens Assistant</div>
        <div class="chat-subtitle">How can I help you today?</div>
      </div>
    </div>
    <div id="chat-area" class="chat-area">
      <div class="bot-message">
        👋 Welcome to Pokar Greens!<br>
      </div>
      <div class="bot-message" id="lang-select-message">
        Which language do you prefer to talk in?
        <div class="lang-buttons">
          <button onclick="selectLanguage('English')">English</button>
          <button onclick="selectLanguage('Hindi')">हिन्दी</button>
          <button onclick="selectLanguage('Gujarati')">ગુજરાતી</button>
        </div>
      </div>
    </div>
    <form onsubmit="sendMessage(event)" class="chat-form">
      <input type="text" id="message" placeholder="Type your question here..." autocomplete="off" required />
      <button type="submit" class="send-btn">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </button>
    </form>
  </div>
  
  <script>
    let selectedLanguage = null;
    const chatArea = document.getElementById('chat-area');
    const messageInput = document.getElementById('message');

    // Auto-resize textarea
    function adjustTextareaHeight() {
      messageInput.style.height = 'auto';
      messageInput.style.height = (messageInput.scrollHeight) + 'px';
    }

    // Handle language selection
    function selectLanguage(lang) {
      selectedLanguage = lang;
      document.getElementById("lang-select-message").remove();
      const confirmation = `Great! I'll talk to you in ${lang}. How can I help you today?`;
      addBotMessage(confirmation);
      messageInput.focus();
    }

    // Add a message to the chat area
    function addMessage(content, isUser = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = isUser ? 'user-message' : 'bot-message';
      messageDiv.innerHTML = content.replace(/\n/g, '<br>');
      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    // Add a bot message
    function addBotMessage(content) {
      addMessage(content, false);
    }

    // Add a user message
    function addUserMessage(content) {
      addMessage(content, true);
    }

    // Send message to the server
    async function sendMessage(event) {
      event.preventDefault();
      
      if (!selectedLanguage) {
        addBotMessage("Please select a language first.");
        return;
      }
      
      const message = messageInput.value.trim();
      if (!message) return;
      
      // Add user message to chat
      addUserMessage(message);
      messageInput.value = '';
      adjustTextareaHeight();
      
      // Show typing indicator
      const typingIndicator = document.createElement('div');
      typingIndicator.className = 'bot-message typing-indicator';
      typingIndicator.innerHTML = 'Typing...';
      chatArea.appendChild(typingIndicator);
      chatArea.scrollTop = chatArea.scrollHeight;
      
      try {
        // Send to backend
        const response = await fetch("/chat", {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({ 
            message: message,
            language: selectedLanguage
          })
        });
        
        // Remove typing indicator
        chatArea.removeChild(typingIndicator);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          addBotMessage("Sorry, I encountered an error. Please try again.");
          console.error("Server error:", data.error);
        } else {
          addBotMessage(data.reply);
        }
      } catch (error) {
        // Remove typing indicator in case of error
        if (typingIndicator.parentNode === chatArea) {
          chatArea.removeChild(typingIndicator);
        }
        
        addBotMessage("Sorry, I'm having trouble connecting to the server. Please try again later.");
        console.error("Error:", error);
      }
    }

    // Handle Enter key (but allow Shift+Enter for new lines)
    messageInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.querySelector('.chat-form').dispatchEvent(new Event('submit'));
      }
    });
    
    // Auto-resize on input
    messageInput.addEventListener('input', adjustTextareaHeight);
    
    // Initial focus
    window.addEventListener('load', () => {
      messageInput.focus();
    });
  </script>
</body>
</html>
